<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QKD Orbit Designer</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <link rel="stylesheet" href="/static/styles/app.css" />
  <script type="importmap">
    {
      "imports": { 
        "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <h1>QKD Orbit Designer</h1>
        <p>Visualize resonant orbits and Earth-to-space optical links</p>
      </div>
      <div class="header-actions">
        <button id="btnPanelToggle" type="button" class="ghost" aria-pressed="false">Show panel</button>
        <button id="btnMapStyle" type="button" class="ghost">Satellite map</button>
        <button id="btnTheme" type="button" class="ghost" aria-pressed="false">Dark mode</button>
      </div>
    </header>

    <main class="workspace">
      <aside id="controlPanel" class="control-panel" data-collapsed="true" aria-expanded="false">
        <nav class="panel-tabs" aria-label="Configuration sections">
          <button type="button" class="is-active" data-section-target="orbit" aria-label="Orbit & Resonance">
            <span class="tab-label">Orbit &amp; Resonance</span>
          </button>
          <button type="button" data-section-target="optics" aria-label="Optical Link">
            <span class="tab-label">Optical Link</span>
          </button>
          <button type="button" data-section-target="stations" aria-label="Ground Stations">
            <span class="tab-label">Ground Stations</span>
          </button>
          <button type="button" data-section-target="analytics" aria-label="Analytics">
            <span class="tab-label">Analytics</span>
          </button>
          <button type="button" data-section-target="weather" aria-label="Weather Layers">
            <span class="tab-label">Weather Layers</span>
          </button>
          <button type="button" data-section-target="atmosphere" aria-label="Atmospheric Models">
            <span class="tab-label">Atmospheric Models</span>
          </button>
          <button type="button" data-section-target="help" aria-label="Help & Documentation">
            <span class="tab-label">Help &amp; Documentation</span>
          </button>
        </nav>
        <div class="panel-content">
          <section class="panel-section is-active" data-section="orbit">
            <header>
              <h2>Orbit &amp; Resonance Setup</h2>
              <p>Define the orbital elements, resonance targets and valid search ranges.</p>
            </header>
            <div class="field">
              <div class="field-label">
                <label for="satelliteName">Satellite name</label>
                <button type="button" class="info-button" aria-label="What is the satellite name?" data-info="Identifier used to label the spacecraft across charts, exports and saved presets.">i</button>
              </div>
              <input id="satelliteName" type="text" value="Sat-QKD" />
            </div>
            <div class="field">
              <div class="field-label">
                <label for="epochInput">Epoch (UTC)</label>
                <button type="button" class="info-button" aria-label="What is the epoch?" data-info="Reference epoch in Coordinated Universal Time at which the orbital elements are valid.">i</button>
              </div>
              <input id="epochInput" type="datetime-local" />
            </div>
            <div class="field">
              <div class="field-label">
                <label>Mode</label>
                <button type="button" class="info-button" aria-label="Simulation mode" data-info="Switch between single-satellite mode and constellation (Walker) design.">i</button>
              </div>
              <div class="mode-select">
                <label><input id="modeIndividual" name="mode" type="radio" value="individual" checked /> Individual</label>
                <label><input id="modeConstellation" name="mode" type="radio" value="constellation" /> Constelación</label>
              </div>
            </div>
            <form id="optimizerForm" class="optimizer" autocomplete="off">
              <div class="field-group">
                <div class="field">
                  <div class="field-label">
                    <label for="semiMajor">Target semi-major axis a0 (km)</label>
                    <button type="button" class="info-button" aria-label="What is the semi-major axis?" data-info="Desired semi-major axis that the resonance search will try to match. It sets the size of the orbit.">i</button>
                  </div>
                  <input id="semiMajor" type="number" step="1" min="6538" max="42164" value="6771" />
                  <input id="semiMajorSlider" type="range" min="6538" max="42164" value="6771" />
                </div>
              </div>
              <div class="field-group">
                <div class="field">
                  <div class="field-label">
                    <label for="optToleranceA">Tolerance ± (km)</label>
                    <button type="button" class="info-button" aria-label="What is the resonance tolerance?" data-info="Half-width around the target semi-major axis accepted when searching for integer resonance ratios.">i</button>
                  </div>
                  <input id="optToleranceA" type="number" inputmode="decimal" min="0" max="1000" step="0.5" value="0" />
                  <input id="optToleranceSlider" type="range" min="0" max="1000" step="0.5" value="0" />
                </div>
              </div>
              <div class="field-group inline">
                <div class="field">
                  <div class="field-label">
                    <label for="resonanceOrbits">Resonance orbits k</label>
                    <button type="button" class="info-button" aria-label="What is k?" data-info="Number of satellite orbits completed during one resonance cycle. Higher k means more orbital periods before the ground track repeats.">i</button>
                  </div>
                  <input id="resonanceOrbits" type="number" min="1" max="500" step="1" value="1" />
                  <input id="resonanceOrbitsSlider" type="range" min="1" max="500" step="1" value="1" />
                </div>
                <div class="field">
                  <div class="field-label">
                    <label for="resonanceRotations">Earth rotations j</label>
                    <button type="button" class="info-button" aria-label="What is j?" data-info="Number of Earth sidereal rotations that occur while the satellite completes k orbits. The j:k ratio defines the resonance.">i</button>
                  </div>
                  <input id="resonanceRotations" type="number" min="1" max="500" step="1" value="1" />
                  <input id="resonanceRotationsSlider" type="range" min="1" max="500" step="1" value="1" />
                </div>
              </div>
              <div class="field-group inline optimizer-bounds">
                <div class="field">
                  <div class="field-label">
                    <label for="optMinRot">Min rotations j</label>
                    <button type="button" class="info-button" aria-label="What is the minimum rotation bound?" data-info="Lower bound for the Earth rotation count considered during the resonance search.">i</button>
                  </div>
                  <input id="optMinRot" type="number" inputmode="numeric" min="1" max="500" step="1" value="1" />
                  <input id="optMinRotSlider" type="range" min="1" max="500" step="1" value="1" />
                </div>
                <div class="field">
                  <div class="field-label">
                    <label for="optMaxRot">Max rotations j</label>
                    <button type="button" class="info-button" aria-label="What is the maximum rotation bound?" data-info="Upper bound for the Earth rotation count explored by the resonance solver.">i</button>
                  </div>
                  <input id="optMaxRot" type="number" inputmode="numeric" min="1" max="500" step="1" value="120" />
                  <input id="optMaxRotSlider" type="range" min="1" max="500" step="1" value="120" />
                </div>
              </div>
              <div class="field-group inline optimizer-bounds">
                <div class="field">
                  <div class="field-label">
                    <label for="optMinOrb">Min orbits k</label>
                    <button type="button" class="info-button" aria-label="What is the minimum orbit bound?" data-info="Lower limit for the satellite orbit count considered by the resonance solver.">i</button>
                  </div>
                  <input id="optMinOrb" type="number" inputmode="numeric" min="1" max="500" step="1" value="1" />
                  <input id="optMinOrbSlider" type="range" min="1" max="500" step="1" value="1" />
                </div>
                <div class="field">
                  <div class="field-label">
                    <label for="optMaxOrb">Max orbits k</label>
                    <button type="button" class="info-button" aria-label="What is the maximum orbit bound?" data-info="Upper limit for the satellite orbit count scanned while searching resonances.">i</button>
                  </div>
                  <input id="optMaxOrb" type="number" inputmode="numeric" min="1" max="500" step="1" value="60" />
                  <input id="optMaxOrbSlider" type="range" min="1" max="500" step="1" value="60" />
                </div>
              </div>
              <p class="hint" data-resonance-hint>Use "Search resonances" to scan for j:k ratios that match the target semi-major axis.</p>
              <div class="optimizer-actions">
                <button id="optSearchBtn" type="submit">Search resonances</button>
              </div>
              <p id="optSummary" class="hint"></p>
              <div id="optResults" class="optimizer-results"></div>
            <div id="optimizationPanel" class="optimizer-panel">
              <h3>Optimización de Constelación</h3>
              <div class="field">
                <label for="simDuration">Duración de simulación (s)</label>
                <input id="simDuration" type="number" min="10" step="10" value="3600" />
              </div>
              <div class="field">
                <label>Puntos de control</label>
                <div class="control-points">
                  <button id="btnDefinePoints" type="button" class="btn-secondary">Definir puntos de control</button>
                  <span id="pointsCount">0 puntos</span>
                </div>
                <div id="pointsList" class="points-list" style="margin-top:6px;max-height:120px;overflow:auto;font-size:0.95em;"></div>
              </div>
              <div class="field">
                <button id="btnOptimize" type="button" class="btn-primary">Optimizar diseño</button>
                <button id="btnCancelOptimize" type="button" class="btn-secondary" style="margin-left:8px;display:none;">Cancelar</button>
                <span id="optStatus" class="hint">--</span>
              </div>
              <div class="field" style="margin-top:6px">
                <label for="optProgress">Progreso</label>
                <progress id="optProgress" max="1" value="0" style="width:100%;display:block"></progress>
              </div>
              <div class="field" style="margin-top:6px">
                <label><input id="workerToggle" type="checkbox" /> Usar Web Worker para precomputación</label>
              </div>
              <div class="field" style="margin-top:6px">
                <label for="workerCount">Workers</label>
                <select id="workerCount">
                  <option value="1">1 (single)</option>
                  <option value="2">2</option>
                  <option value="4">4</option>
                </select>
              </div>
            </div>
            </form>
            <div id="walkerPanel" class="field-group" hidden>
              <header>
                <h3>Walker Delta parameters</h3>
                <p class="hint">Define T (total sats), P (planes) and F (phasing)</p>
              </header>
              <div class="field">
                <div class="field-label">
                  <label for="walkerT">T (total satellites)</label>
                </div>
                <input id="walkerT" type="number" min="1" value="24" />
              </div>
              <div class="field">
                <div class="field-label">
                  <label for="walkerP">P (planes)</label>
                </div>
                <input id="walkerP" type="number" min="1" value="6" />
              </div>
              <div class="field">
                <div class="field-label">
                  <label for="walkerF">F (phasing)</label>
                </div>
                <input id="walkerF" type="number" min="0" value="1" />
              </div>
            </div>

            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="eccentricity">Eccentricity e</label>
                  <button type="button" class="info-button" aria-label="What is eccentricity?" data-info="Controls the shape of the orbit. e = 0 is circular, higher values increase perigee-apogee difference." >i</button>
                </div>
                <input id="eccentricity" type="number" step="0.001" min="0" max="0.2" value="0.001" />
                <input id="eccentricitySlider" type="range" min="0" max="0.2" step="0.001" value="0.001" />
              </div>
            </div>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="inclination">Inclination i (deg)</label>
                  <button type="button" class="info-button" aria-label="What is inclination?" data-info="Tilt of the orbital plane with respect to Earth's equator, in degrees." >i</button>
                </div>
                <input id="inclination" type="number" step="0.1" min="0" max="180" value="53" />
                <input id="inclinationSlider" type="range" min="0" max="180" step="0.1" value="53" />
              </div>
            </div>
            <div class="field-group inline">
              <div class="field">
                <div class="field-label">
                  <label for="raan">RAAN Ω (deg)</label>
                  <button type="button" class="info-button" aria-label="What is RAAN?" data-info="Right Ascension of the Ascending Node. Sets the orientation of the orbital plane with respect to the inertial frame." >i</button>
                </div>
                <input id="raan" type="number" step="0.1" min="0" max="360" value="0" />
                <input id="raanSlider" type="range" min="0" max="360" step="0.1" value="0" />
              </div>
              <div class="field">
                <div class="field-label">
                  <label for="argPerigee">Argument of perigee ω (deg)</label>
                  <button type="button" class="info-button" aria-label="What is argument of perigee?" data-info="Angle from the ascending node to the orbit's perigee within the orbital plane." >i</button>
                </div>
                <input id="argPerigee" type="number" step="0.1" min="0" max="360" value="0" />
                <input id="argPerigeeSlider" type="range" min="0" max="360" step="0.1" value="0" />
              </div>
            </div>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="meanAnomaly">Mean anomaly M₀ (deg)</label>
                  <button type="button" class="info-button" aria-label="What is mean anomaly?" data-info="Defines the spacecraft position along the orbit at the epoch, expressed as mean anomaly." >i</button>
                </div>
                <input id="meanAnomaly" type="number" step="0.1" min="0" max="360" value="0" />
                <input id="meanAnomalySlider" type="range" min="0" max="360" step="0.1" value="0" />
              </div>
            </div>
          </section>

          <div id="orbitMessages" class="panel-messages" hidden></div>

          <section class="panel-section" data-section="optics">
            <header>
              <h2>Optical Link</h2>
              <p>Set the apertures, wavelength and temporal sampling used to evaluate the link budget.</p>
            </header>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="satAperture">Satellite aperture (m)</label>
                  <button type="button" class="info-button" aria-label="Satellite aperture info" data-info="Diameter of the satellite transmitting telescope. Larger apertures reduce beam divergence and geometric losses.">i</button>
                </div>
                <input id="satAperture" type="number" min="0.1" max="3" step="0.05" value="0.6" />
                <input id="satApertureSlider" type="range" min="0.1" max="3" step="0.05" value="0.6" />
              </div>
            </div>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="groundAperture">Ground aperture (m)</label>
                  <button type="button" class="info-button" aria-label="Ground aperture info" data-info="Diameter of the ground station receiving telescope. It defines the collecting area and affects coupling efficiency.">i</button>
                </div>
                <input id="groundAperture" type="number" min="0.1" max="5" step="0.05" value="1.0" />
                <input id="groundApertureSlider" type="range" min="0.1" max="5" step="0.05" value="1.0" />
              </div>
            </div>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="wavelength">Wavelength (nm)</label>
                  <button type="button" class="info-button" aria-label="Wavelength info" data-info="Operating wavelength of the optical link in nanometres. It drives diffraction, atmospheric absorption and detector efficiency.">i</button>
                </div>
                <input id="wavelength" type="number" min="600" max="1700" step="1" value="810" />
                <input id="wavelengthSlider" type="range" min="600" max="1700" step="1" value="810" />
              </div>
            </div>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="samplesPerOrbit">Samples per orbit</label>
                  <button type="button" class="info-button" aria-label="Samples per orbit info" data-info="Number of time samples evaluated for each orbital period. More samples capture finer variations along the pass at the cost of computation time.">i</button>
                </div>
                <input id="samplesPerOrbit" type="number" min="60" max="720" step="10" value="180" />
                <input id="samplesPerOrbitSlider" type="range" min="60" max="720" step="10" value="180" />
              </div>
            </div>
          </section>

          <section class="panel-section" data-section="stations">
            <header>
              <h2>Ground Stations</h2>
              <p>Select, add or focus ground terminals and define site-specific turbulence inputs.</p>
            </header>
            <div class="field">
              <div class="field-label">
                <label for="stationSelect">Active ground station</label>
                <button type="button" class="info-button" aria-label="Ground station selector info" data-info="Choose the ground station used for link calculations. Custom stations can be added or removed below.">i</button>
              </div>
            </div>
            <div class="station-toolbar">
              <select id="stationSelect" aria-label="Ground station list"></select>
              <button id="btnAddStation" type="button" title="Add a new ground station">Add</button>
              <button id="btnDeleteStation" type="button" title="Remove the selected station">Delete</button>
              <button id="btnFocusStation" type="button" title="Fly the map to the selected station">Focus</button>
            </div>

            <h4>Site turbulence parameters</h4>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="groundCn2Day">Ground Cn² (day) at h = 0</label>
                  <button type="button" class="info-button" aria-label="Daytime Cn2 info" data-info="Surface structure constant used when the station is sunlit. Guides the Hufnagel-Valley turbulence profile generation.">i</button>
                </div>
                <input id="groundCn2Day" type="text" value="5e-14" />
              </div>
            </div>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="groundCn2Night">Ground Cn² (night) at h = 0</label>
                  <button type="button" class="info-button" aria-label="Nighttime Cn2 info" data-info="Surface structure constant used during local night-time conditions. Lower values usually indicate calmer turbulence." >i</button>
                </div>
                <input id="groundCn2Night" type="text" value="5e-15" />
              </div>
            </div>
          </section>

          <section class="panel-section" data-section="analytics">
            <header>
              <h2>Analytics</h2>
              <p>Inspect instantaneous link performance and plot full-pass trends.</p>
            </header>
            <section class="instant-metrics" aria-live="polite">
              <h4>Link metrics at current time</h4>
              <p>
                <span class="metric-label">Link loss (dB)
                  <button type="button" class="info-button" aria-label="Link loss info" data-info="Total geometric plus atmospheric attenuation in decibels at the current simulation time.">i</button>
                </span>
                <strong id="lossMetric">--</strong>
              </p>
              <p>
                <span class="metric-label">Elevation (deg)
                  <button type="button" class="info-button" aria-label="Elevation info" data-info="Angle between the station horizon and the satellite line-of-sight. Higher elevation generally improves link quality.">i</button>
                </span>
                <strong id="elevationMetric">--</strong>
              </p>
              <p>
                <span class="metric-label">Range (km)
                  <button type="button" class="info-button" aria-label="Range info" data-info="Instantaneous slant range between the satellite and the ground station in kilometres.">i</button>
                </span>
                <strong id="distanceMetric">--</strong>
              </p>
              <p>
                <span class="metric-label">Zenith angle (deg)
                  <button type="button" class="info-button" aria-label="Zenith angle info" data-info="Complementary angle to elevation, measuring the deviation from the station zenith.">i</button>
                </span>
                <strong id="zenithMetric">--</strong>
              </p>
              <p>
                <span class="metric-label">Doppler shift (Hz)
                  <button type="button" class="info-button" aria-label="Doppler info" data-info="Frequency offset caused by the relative radial velocity between satellite and ground station.">i</button>
                </span>
                <strong id="dopplerMetric">--</strong>
              </p>
              <p>
                <span class="metric-label">Fried parameter r0 (m)
                  <button type="button" class="info-button" aria-label="Fried parameter info" data-info="Atmospheric coherence diameter derived from the current turbulence model. Larger r0 means weaker turbulence.">i</button>
                </span>
                <strong id="r0Metric">--</strong>
              </p>
              <p>
                <span class="metric-label">Greenwood frequency (Hz)
                  <button type="button" class="info-button" aria-label="Greenwood frequency info" data-info="Characteristic turbulence temporal frequency that sets the bandwidth required for adaptive optics.">i</button>
                </span>
                <strong id="fGMetric">--</strong>
              </p>
              <p>
                <span class="metric-label">Isoplanatic angle (&quot;)
                  <button type="button" class="info-button" aria-label="Isoplanatic angle info" data-info="Angular region over which wavefront distortions are correlated. Expressed in arcseconds." >i</button>
                </span>
                <strong id="theta0Metric">--</strong>
              </p>
              <p>
                <span class="metric-label">RMS wind (m/s)
                  <button type="button" class="info-button" aria-label="Wind info" data-info="Root-mean-square high-altitude wind speed driving turbulence layers within the chosen model.">i</button>
                </span>
                <strong id="windMetric">--</strong>
              </p>
            </section>
            <h4>Full pass metrics</h4>
            <p>Select a metric to plot its evolution over the entire simulated pass.</p>
            <ul class="metric-graph-list">
              <li>
                <span>Geometric loss (dB)
                  <button type="button" class="info-button" aria-label="Geometric loss plot info" data-info="Plots the free-space and pointing losses due to beam divergence and station aperture over the full pass.">i</button>
                </span>
                <button type="button" class="btn-show-graph" data-graph-id="loss">Show graph</button>
              </li>
              <li>
                <span>Station elevation (deg)
                  <button type="button" class="info-button" aria-label="Elevation plot info" data-info="Shows the elevation angle of the satellite as seen from the station versus time." >i</button>
                </span>
                <button type="button" class="btn-show-graph" data-graph-id="elevation">Show graph</button>
              </li>
              <li>
                <span>Satellite-ground range (km)
                  <button type="button" class="info-button" aria-label="Range plot info" data-info="Displays the changing distance between satellite and ground station for the selected pass." >i</button>
                </span>
                <button type="button" class="btn-show-graph" data-graph-id="distance">Show graph</button>
              </li>
              <li>
                <span>Fried parameter r0 vs time
                  <button type="button" class="info-button" aria-label="r0 plot info" data-info="Tracks the turbulence coherence diameter predicted along the pass, useful for adaptive optics design." >i</button>
                </span>
                <button type="button" class="btn-show-graph" data-graph-id="r0">Show graph</button>
              </li>
              <li>
                <span>Greenwood frequency vs time
                  <button type="button" class="info-button" aria-label="fG plot info" data-info="Shows how the Greenwood frequency evolves, indicating the turbulence bandwidth requirements." >i</button>
                </span>
                <button type="button" class="btn-show-graph" data-graph-id="fG">Show graph</button>
              </li>
              <li>
                <span>Isoplanatic angle vs time
                  <button type="button" class="info-button" aria-label="Isoplanatic plot info" data-info="Evolution of the isoplanatic angle, useful for evaluating adaptive optics field-of-view.">i</button>
                </span>
                <button type="button" class="btn-show-graph" data-graph-id="theta0">Show graph</button>
              </li>
              <li>
                <span>RMS wind speed vs time
                  <button type="button" class="info-button" aria-label="Wind plot info" data-info="High-altitude wind speed used in turbulence models across the simulated pass." >i</button>
                </span>
                <button type="button" class="btn-show-graph" data-graph-id="wind">Show graph</button>
              </li>
            </ul>
          </section>

          <section class="panel-section" data-section="weather">
            <header>
              <h2>Weather Layers</h2>
              <p>Sample Open-Meteo pressure level fields globally and project them on the map.</p>
            </header>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="weatherFieldSelect">Parameter</label>
                  <button type="button" class="info-button" aria-label="Weather field info" data-info="Choose the atmospheric parameter to sample globally from Open-Meteo forecast or reanalysis data.">i</button>
                </div>
                <select id="weatherFieldSelect"></select>
              </div>
            </div>
            <div class="field-group inline">
              <div class="field">
                <div class="field-label">
                  <label for="weatherLevelSelect">Pressure level (hPa)</label>
                  <button type="button" class="info-button" aria-label="Pressure level info" data-info="Select the pressure surface that corresponds to the desired altitude band.">i</button>
                </div>
                <select id="weatherLevelSelect"></select>
              </div>
              <div class="field">
                <div class="field-label">
                  <label for="weatherSamples">Samples</label>
                  <button type="button" class="info-button" aria-label="Samples info" data-info="Controls the number of sample points taken worldwide. More samples provide smoother gradients but take longer to fetch.">i</button>
                </div>
                <input id="weatherSamples" type="number" min="16" max="900" step="8" value="120" />
                <input id="weatherSamplesSlider" type="range" min="16" max="900" step="8" value="120" />
              </div>
            </div>
            <div class="field-group">
              <div class="field">
                <div class="field-label">
                  <label for="weatherTime">Field timestamp (UTC)</label>
                  <button type="button" class="info-button" aria-label="Weather time info" data-info="UTC time corresponding to the hourly slice requested from Open-Meteo.">i</button>
                </div>
                <input id="weatherTime" type="datetime-local" />
              </div>
            </div>
            <div class="field-group inline">
              <button id="weatherFetchBtn" type="button">Fetch field</button>
              <button id="weatherClearBtn" type="button" class="ghost">Clear overlay</button>
            </div>
            <p id="weatherStatus" class="hint"></p>
          </section>

          <section class="panel-section" data-section="atmosphere">
            <header>
              <h2>Atmospheric Models</h2>
              <p>Select turbulence and attenuation models fed by Open-Meteo data to drive the link budget.</p>
            </header>
            <fieldset class="model-selector" role="radiogroup" aria-label="Atmospheric turbulence models">
              <legend class="sr-only">Atmospheric turbulence model</legend>
              <label class="model-card">
                <input type="radio" name="atmosModel" value="hufnagel-valley" data-atmos-model="hufnagel-valley" checked />
                <div class="model-card-body">
                  <div class="model-card-header">
                    <span>Hufnagel-Valley 5/7</span>
                    <button type="button" class="info-button" aria-label="Hufnagel-Valley info" data-info="Classic parametric turbulence profile combining surface Cn² values with high-altitude wind speed. Provides analytic formulas for r0, θ0 and fG.">i</button>
                  </div>
                  <p>Uses surface Cn² day/night inputs and Open-Meteo wind components at 300 hPa to estimate turbulence strength.</p>
                  <ul class="model-data-list">
                    <li><strong>Open-Meteo</strong>: wind_u_component_300hPa, wind_v_component_300hPa</li>
                    <li><strong>Site inputs</strong>: Cn²(0) day/night</li>
                    <li><strong>Outputs</strong>: r₀, θ₀, f<sub>G</sub>, wind RMS</li>
                  </ul>
                </div>
              </label>
              <label class="model-card">
                <input type="radio" name="atmosModel" value="bufton" data-atmos-model="bufton" />
                <div class="model-card-body">
                  <div class="model-card-header">
                    <span>Bufton boundary-layer</span>
                    <button type="button" class="info-button" aria-label="Bufton info" data-info="Empirical boundary-layer model blending surface meteorology with wind shear to estimate Cn² vertical gradients.">i</button>
                  </div>
                  <p>Extends the surface Cn² inputs with wind and temperature gradients from Open-Meteo to refine low-altitude turbulence.</p>
                  <ul class="model-data-list">
                    <li><strong>Open-Meteo</strong>: wind components at 300/500/850 hPa, temperature_850hPa</li>
                    <li><strong>Site inputs</strong>: Cn²(0) day/night, local lapse rate (future)</li>
                    <li><strong>Outputs</strong>: Layered r₀, θ₀, scintillation index</li>
                  </ul>
                </div>
              </label>
              <label class="model-card">
                <input type="radio" name="atmosModel" value="greenwood" data-atmos-model="greenwood" />
                <div class="model-card-body">
                  <div class="model-card-header">
                    <span>Greenwood lidar-inspired</span>
                    <button type="button" class="info-button" aria-label="Greenwood model info" data-info="Piecewise turbulence model driven by measured wind speeds and temperature to estimate adaptive optics bandwidth requirements.">i</button>
                  </div>
                  <p>Targets adaptive optics design by combining wind-shear derived layer speeds with humidity to infer scintillation and coherence time.</p>
                  <ul class="model-data-list">
                    <li><strong>Open-Meteo</strong>: wind_u/v at 200 &amp; 300 hPa, temperature_200hPa, relative_humidity_700hPa</li>
                    <li><strong>Derived</strong>: Greenwood frequency, coherence time τ<sub>0</sub></li>
                  </ul>
                </div>
              </label>
            </fieldset>
            <div class="data-sources">
              <div class="field-label">
                <h4>Planned Open-Meteo drivers</h4>
                <button type="button" class="info-button" aria-label="Open-Meteo data info" data-info="Overview of the atmospheric variables that will be requested from Open-Meteo to feed the selected model.">i</button>
              </div>
              <ul class="data-list">
                <li>High-altitude wind vectors (200 hPa, 300 hPa, 500 hPa)</li>
                <li>Temperature profiles at 200/300/500/850 hPa</li>
                <li>Relative humidity or specific humidity for moisture-dependent losses</li>
                <li>Shortwave radiation and direct normal irradiance for background noise estimates</li>
                <li>Surface pressure and planetary boundary layer height (future integration)</li>
              </ul>
            </div>
          </section>

          <section class="panel-section" data-section="help" hidden>
            <header>
              <h2>Help &amp; Documentation</h2>
              <p>Reference and developer documentation for the simulator. Choose a topic below.</p>
            </header>
            <nav class="help-nav" aria-label="Help topics">
              <button type="button" data-help-topic="orbits">Orbits (elements, epochs)</button>
              <button type="button" data-help-topic="resonance">Resonance logic (j:k search)</button>
              <button type="button" data-help-topic="walker">Walker constellations</button>
              <button type="button" data-help-topic="optimization">Optimizer (adaptive random search)</button>
              <button type="button" data-help-topic="propagation">Propagation &amp; J2 model</button>
              <button type="button" data-help-topic="backend">Backend TLE provider</button>
              <button type="button" data-help-topic="workers">Web Workers &amp; precomputation</button>
            </nav>
            <div class="help-content">
              <article id="help-orbits">
                <h3>Orbits</h3>
                <p>The simulator represents orbits using classical Keplerian elements (a, e, i, Ω, ω, M). The epoch input sets the reference time at which mean anomaly and RAAN/argument are defined. Semi-major axis is provided in kilometers. The internal propagation converts mean anomaly to eccentric anomaly using Newton's method and then to ECI coordinates for rendering and metrics.</p>
              </article>
              <article id="help-resonance" hidden>
                <h3>Resonance solver (j:k)</h3>
                <p>Resonance is computed by searching integer pairs (j, k) where j is Earth sidereal rotations and k is satellite orbits during the same time window. For a target semi-major axis the tool evaluates orbital period and finds j:k pairs whose derived semi-major axis lies within the tolerance. The search scans bounds set by the min/max rotations and orbits controls.</p>
              </article>
              <article id="help-walker" hidden>
                <h3>Walker constellation generation</h3>
                <p>Walker Δ patterns are created by distributing T satellites across P planes with phase F. The generator computes RAAN offsets and mean anomaly phasing to place satellites evenly across planes and along-track. Outputs are simple element sets that the propagation engine uses for visualization.</p>
              </article>
              <article id="help-optimization" hidden>
                <h3>Optimizer</h3>
                <p>The optimizer uses an adaptive random-search heuristic. It mutates candidate constellations (perturbing RAAN, mean anomaly, or orbital elements) and evaluates a revisit-time metric against user-defined control points. The evaluation uses precomputed timelines for satellite positions to avoid per-frame propagation overhead. The best solution is stored in the state and can be applied to the active orbit.</p>
              </article>
              <article id="help-propagation" hidden>
                <h3>Propagation and J2</h3>
                <p>Propagation is implemented using classical Kepler motion with an added J2 secular approximation: RAAN and argument of perigee secular rates are applied to each sample to simulate Earth's oblateness effects efficiently. For high fidelity needs a full SGP4 engine would be preferable, but the current approach balances performance and realism for planning tasks.</p>
              </article>
              <article id="help-backend" hidden>
                <h3>Backend / TLE provider</h3>
                <p>The backend exposes an API that fetches and caches TLE groups from CelesTrak. Requests are cached in-memory with a TTL to avoid repeated remote fetches. The frontend can request `/api/tles/{group}` to retrieve TLE sets for overlaying constellations.</p>
              </article>
              <article id="help-workers" hidden>
                <h3>Web Workers &amp; precomputation</h3>
                <p>Heavy propagation work is moved to Web Workers (optional). Workers accept batches of elements and timeline parameters, propagate each satellite, and stream partial results back to the main thread to render incremental polylines. Using transferable arrays and a worker pool reduces UI freezes for large constellations.</p>
              </article>
            </div>
          </section>
        </div>
      </aside>

      <div id="panelResizer" class="panel-resizer" role="separator" aria-orientation="vertical" aria-controls="controlPanel" aria-label="Adjust panel width" tabindex="0"></div>

      <section class="visual-area">
        <button id="panelReveal" class="panel-reveal" type="button" hidden>Show controls</button>
        <div class="view-toolbar" role="tablist">
          <button class="is-active" data-view="dual" role="tab" aria-selected="true">Dual view</button>
          <button data-view="3d" role="tab" aria-selected="false">3D only</button>
          <button data-view="2d" role="tab" aria-selected="false">2D only</button>
        </div>
        <div class="constellation-controls" id="constellationControls">
          <h3>Constellation overlays</h3>
          <div class="constellation-list" id="constellationList" role="group" aria-label="Toggle satellite constellations"></div>
          <p class="constellation-status hint" id="constellationStatus" hidden></p>
        </div>
        <div class="view-grid" id="viewGrid" data-active-view="dual">
          <div id="threeContainer" class="view-pane view-3d" aria-label="3D globe">
            <canvas id="threeCanvas" class="globe-canvas" aria-hidden="true"></canvas>
            <div id="threeFallback" hidden>Could not initialize the 3D scene.</div>
          </div>
          <div id="mapContainer" class="view-pane view-2d" aria-label="2D map"></div>
        </div>
        <div class="timeline">
          <div class="timeline-header">
            <strong>Time control</strong>
            <div class="timeline-actions">
              <button id="btnPlay" type="button">▶</button>
              <button id="btnPause" type="button">⏸</button>
              <button id="btnStepBack" type="button">⏪</button>
              <button id="btnStepForward" type="button">⏩</button>
              <button id="btnResetTime" type="button">↺</button>
              <label for="timeWarp">Speed</label>
              <select id="timeWarp">
                <option value="1">x1</option>
                <option value="5">x5</option>
                <option value="10">x10</option>
                <option value="30">x30</option>
                <option value="60" selected>x60</option>
                <option value="120">x120</option>
                <option value="300">x300</option>
                <option value="600">x600</option>
                <option value="900">x900</option>
                <option value="1800">x1800</option>
                <option value="3600">x3600</option>
              </select>
            </div>
          </div>
          <input id="timeSlider" type="range" min="0" max="1" step="1" value="0" />
          <div class="timeline-readout">
            <span>t = <span id="timeLabel">0 s</span></span>
            <span class="spacer">·</span>
            <span>Elevation: <span id="elevationLabel">--</span></span>
            <span class="spacer">·</span>
            <span>Geometric loss: <span id="lossLabel">--</span></span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <dialog id="stationDialog" class="station-dialog">
    <form method="dialog" class="dialog-content">
      <div class="dialog-header dialog-drag-handle">
        <h2>New ground station</h2>
      </div>
      <label>Name<input id="stationName" required /></label>
      <label>Latitude (°)<input id="stationLat" type="number" min="-90" max="90" step="0.0001" placeholder="Enter or pick from map" required /></label>
      <label>Longitude (°)<input id="stationLon" type="number" min="-180" max="180" step="0.0001" placeholder="Enter or pick from map" required /></label>
      <label>Aperture (m)<input id="stationAperture" type="number" min="0.1" max="8" step="0.1" value="1.0" required /></label>
      <div class="station-picker-actions">
        <button id="stationPickOnMap" type="button">Pick on map</button>
        <p id="stationPickHint" class="station-pick-hint" hidden>Click the map to set the location.</p>
      </div>
      <menu>
        <button id="stationCancel" type="button">Cancel</button>
        <button id="stationSave" value="default">Save</button>
      </menu>
    </form>
  </dialog>

  <template id="stationOptionTemplate">
    <option></option>
  </template>

  <dialog id="graphModal" aria-labelledby="graphModalTitle">
    <h3 id="graphModalTitle">Graph</h3>
    <div class="modal-chart-container">
      <canvas id="modalChartCanvas"></canvas>
    </div>
    <button id="closeGraphModal" type="button">Close</button>
  </dialog> 

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/satellite.js@4.1.4/dist/satellite.min.js" crossorigin="anonymous"></script>
  <script type="module" src="/static/app.js"></script>
</body>
</html>
